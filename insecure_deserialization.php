<?php
class DatabaseConfig {
    public $hostname = "localhost";
    public $username = "root";
    public $password = "";

    function __wakeup() {
        echo "Wakeup Triggered! Hostname: " . htmlspecialchars($this->hostname) . "<br>";
        try {
            echo "Attempting shell_exec...<br>";
            $output = shell_exec("ping -c 4 " . escapeshellarg($this->hostname)); // Use -c 4 for Linux
            echo "shell_exec executed.<br>";
            if ($output) {
                echo "<pre>Ping Output:\n" . htmlspecialchars($output) . "</pre>";
            } else {
                echo "<pre>Ping command failed</pre>";
            }
        } catch (Exception $e) {
            echo "Exception during shell_exec: " . htmlspecialchars($e->getMessage()) . "<br>";
        }
    }
}

// Enable error reporting for debugging
error_reporting(E_ALL);
ini_set('display_errors', 1);

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['data'])) {
    echo "<h3>Step 1: Raw POST Input</h3>";
    $input = $_POST['data'];
    echo "<pre>" . htmlspecialchars($input) . "</pre>";

    echo "<h3>Step 2: Base64 Decoding</h3>";
    $decoded = base64_decode($input);
    if ($decoded === false) {
        echo "<pre>Error: Invalid Base64 Data</pre>";
        exit;
    }
    echo "<pre>Decoded Data:\n" . htmlspecialchars($decoded) . "</pre>";

    echo "<h3>Step 3: Attempting Unserialization</h3>";
    try {
        $object = unserialize($decoded);
        if ($object instanceof DatabaseConfig) {
            echo "<pre>Deserialization successful! Object properties:</pre>";
            echo "<pre>Hostname: " . htmlspecialchars($object->hostname) . "</pre>";
        } else {
            echo "<pre>Error: Deserialized data is not an instance of DatabaseConfig</pre>";
        }
    } catch (Exception $e) {
        echo "<pre>Unserialization Error: " . htmlspecialchars($e->getMessage()) . "</pre>";
    }
}
?>
<!DOCTYPE html>
<html>
<head>
    <title>Insecure Deserialization Example</title>
</head>
<body>
    <h1>Insecure Deserialization Test Page</h1>
    <form method="POST" action="">
        <input type="text" name="data" size="50" placeholder="Enter serialized data">
        <input type="submit" value="Submit">
    </form>

    <!-- Add helper text -->
    <div style="margin-top: 20px">
        <p>Test with this payload (copy & paste into input):</p>
        <code>
            <?php
            // Generate and display a sample payload for testing
            $obj = new DatabaseConfig();
            $obj->hostname = "127.0.0.1"; // Change hostname for testing
            echo base64_encode(serialize($obj));
            ?>
        </code>
    </div>
</body>
</html>
