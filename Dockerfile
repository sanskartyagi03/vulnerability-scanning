FROM php:8.1-apache

# Install required packages and PHP extensions
RUN apt-get update && apt-get install -y \
    mariadb-client \
    libpng-dev \
    && docker-php-ext-install mysqli pdo pdo_mysql gd

# Enable Apache modules
RUN a2enmod rewrite

# Download and extract DVWA
RUN cd /var/www/ \
    && rm -rf html \
    && curl -L https://github.com/digininja/DVWA/archive/master.tar.gz | tar xz \
    && mv DVWA-master html

# Set permissions
RUN chown -R www-data:www-data /var/www/html

# Copy our custom vulnerable code
COPY vulnerable_code/ /var/www/html/vulnerabilities/custom/

# Copy custom config
COPY config.inc.php /var/www/html/config/

# Install Node.js
RUN apt-get update && apt-get install -y nodejs npm

# Add the vulnerable JavaScript file
COPY vulnerable_code/prototype_pollution.js /var/www/html/vulnerable_code/prototype_pollution.js
WORKDIR /var/www/html/vulnerable_code

# Install dependencies
RUN npm install express body-parser
WORKDIR /var/www/html
# Expose the port and run the server
EXPOSE 3000
EXPOSE 80
CMD ["node", "./vulnerable_code/prototype_pollution.js"]
